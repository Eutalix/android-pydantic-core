name: Build Android Wheels

on:
  workflow_dispatch:
  
env:
  PACKAGE_NAME: pydantic-core
  NDK_VERSION: '25.2.9519653' # NDK r25b (Stable for Rust/Python cross-compilation)
  ANDROID_API: 24

jobs:
  check-pypi:
    name: Check PyPI Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.pypi.outputs.version }}
    steps:
      - id: pypi
        run: |
          VER=$(curl -s https://pypi.org/pypi/${{ env.PACKAGE_NAME }}/json | python3 -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
          echo "Latest version on PyPI: $VER"
          echo "version=$VER" >> $GITHUB_OUTPUT

  build-wheels:
    needs: check-pypi
    name: Build ${{ matrix.arch }} (Py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
        arch: ['arm64-v8a', 'armeabi-v7a', 'x86', 'x86_64']
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Rust & Targets
        run: |
          pip install maturin
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source "$HOME/.cargo/env"
          rustup target add aarch64-linux-android armv7-linux-androideabi i686-linux-android x86_64-linux-android

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK r25b
        run: |
          echo "Installing NDK ${{ env.NDK_VERSION }}..."
          yes | sdkmanager "ndk;${{ env.NDK_VERSION }}" > /dev/null
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Build Wheel
        id: build
        run: |
          set -e
          source "$HOME/.cargo/env"

          # --- Environment Setup ---
          PY_VER="${{ matrix.python-version }}"
          PKG_VER="${{ needs.check-pypi.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          
          # Required by Maturin for Android builds
          export ANDROID_API_LEVEL=${{ env.ANDROID_API }}
          
          # NDK Paths
          NDK_BIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"
          NDK_SYSROOT="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          export PATH="$NDK_BIN:$PATH"

          # --- Target Configuration ---
          if [ "$ARCH" == "arm64-v8a" ]; then
             RUST_TARGET="aarch64-linux-android"
             CC_TARGET="aarch64-linux-android${ANDROID_API}"
             NDK_LIB_ARCH="aarch64-linux-android"
             PLAT_TAG="linux_aarch64"
          elif [ "$ARCH" == "armeabi-v7a" ]; then
             RUST_TARGET="armv7-linux-androideabi"
             CC_TARGET="armv7a-linux-androideabi${ANDROID_API}"
             NDK_LIB_ARCH="arm-linux-androideabi"
             PLAT_TAG="linux_armv7l"
          elif [ "$ARCH" == "x86" ]; then
             RUST_TARGET="i686-linux-android"
             CC_TARGET="i686-linux-android${ANDROID_API}"
             NDK_LIB_ARCH="i686-linux-android"
             PLAT_TAG="linux_i686"
          elif [ "$ARCH" == "x86_64" ]; then
             RUST_TARGET="x86_64-linux-android"
             CC_TARGET="x86_64-linux-android${ANDROID_API}"
             NDK_LIB_ARCH="x86_64-linux-android"
             PLAT_TAG="linux_x86_64"
          fi
          
          CLANG_WRAPPER="${CC_TARGET}-clang"

          # Configure Linker for Cargo
          LINKER_VAR="CARGO_TARGET_$(echo "$RUST_TARGET" | tr '[:lower:]-' '[:upper:]_')_LINKER"
          if [ -f "$NDK_BIN/$CLANG_WRAPPER" ]; then
             export $LINKER_VAR="$NDK_BIN/$CLANG_WRAPPER"
          else
             export $LINKER_VAR="$NDK_BIN/clang"
          fi

          # --- Mocking Python Environment ---
          # We create a fake libpython to satisfy the linker without using python-for-android
          MOCK_DIR="$(pwd)/mock_libs"
          mkdir -p "$MOCK_DIR"

          # Generate fake libpython ELF
          "$NDK_BIN/clang" --target=$CC_TARGET -shared -o "$MOCK_DIR/libpython$PY_VER.so" -xc /dev/null

          # Copy real libdl.so from NDK
          LIBDL_PATH=$(find "$NDK_SYSROOT" -name "libdl.so" | grep "$NDK_LIB_ARCH" | head -n 1)
          cp "$LIBDL_PATH" "$MOCK_DIR/"
          
          # Create fake sysconfigdata
          cat > "$MOCK_DIR/_sysconfigdata__linux_${RUST_TARGET}.py" <<EOF
          build_time_vars = {
              'SO': '.so', 'SOABI': 'cpython-$PY_VER', 'EXT_SUFFIX': '.so',
              'LIBDIR': '$MOCK_DIR', 'LDLIBRARY': 'libpython$PY_VER.so',
              'Py_ENABLE_SHARED': 1, 'CC': 'clang', 'CXX': 'clang++',
              'VERSION': '$PY_VER', 'LDSHARED': 'clang -shared',
              'LDFLAGS': '', 'CCSHARED': '-fPIC', 'GNULD': 'yes',
          }
          EOF

          export PYO3_CROSS_LIB_DIR="$MOCK_DIR"
          export PYTHONPATH="$MOCK_DIR:$PYTHONPATH"
          export PYO3_CROSS_PYTHON_VERSION="$PY_VER"
          export LIBRARY_PATH="$MOCK_DIR:$LIBRARY_PATH"

          # Configure Rust Flags
          RUSTFLAGS_VAR="CARGO_TARGET_$(echo "$RUST_TARGET" | tr '[:lower:]-' '[:upper:]_')_RUSTFLAGS"
          export $RUSTFLAGS_VAR="-L native=$MOCK_DIR -C link-arg=--target=$CC_TARGET -C link-arg=-Wl,--unresolved-symbols=ignore-all"

          # --- Build Process ---
          mkdir -p build_src && cd build_src
          pip download "${{ env.PACKAGE_NAME }}==$PKG_VER" --no-binary :all: --no-deps
          tar -xzf pydantic?core-*.tar.gz
          cd pydantic?core-*/

          maturin build --release --strip --target "$RUST_TARGET" --interpreter python$PY_VER --skip-auditwheel

          # --- Rename and Output ---
          cd target/wheels
          OLD=$(ls *.whl)
          # Rename platform tag to linux_xxx to ensure Termux compatibility
          NEW=$(echo "$OLD" | sed -E "s/(-[^-]+)\.whl$/-${PLAT_TAG}.whl/")
          mv "$OLD" "$NEW"
          
          FULL_PATH="$(pwd)/$NEW"
          echo "WHEEL_PATH=$FULL_PATH" >> $GITHUB_OUTPUT

      - name: Upload Temporary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.python-version }}-${{ matrix.arch }}
          path: ${{ steps.build.outputs.WHEEL_PATH }}
          retention-days: 1

  create-pr:
    name: Create Pull Request
    needs: [check-pypi, build-wheels]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: temp_wheels
          merge-multiple: true

      - name: Organize Directory Structure
        run: |
          PKG_VER="${{ needs.check-pypi.outputs.version }}"
          PKG_NAME="${{ env.PACKAGE_NAME }}"
          
          echo "Organizing files for $PKG_NAME v$PKG_VER..."
          
          for wheel in temp_wheels/*.whl; do
            filename=$(basename "$wheel")
            
            # Extract Python version from filename (e.g., cp310)
            py_tag=$(echo "$filename" | grep -oP 'cp\d+' | head -n1)
            py_num=${py_tag#cp}
            
            # Format 310 -> 3.10
            if [ ${#py_num} -eq 2 ]; then
               py_folder="${py_num:0:1}.${py_num:1:1}"
            else
               py_folder="${py_num:0:1}.${py_num:1:2}"
            fi
            
            # Target Structure: python/3.10/pydantic-core/2.41.5/
            TARGET_DIR="python/$py_folder/$PKG_NAME/$PKG_VER"
            
            mkdir -p "$TARGET_DIR"
            mv "$wheel" "$TARGET_DIR/"
            echo "Moved $filename -> $TARGET_DIR/"
          done
          
          # Clean up
          rm -rf temp_wheels

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: Add wheels for ${{ env.PACKAGE_NAME }} v${{ needs.check-pypi.outputs.version }}"
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          branch: "add-wheels-${{ needs.check-pypi.outputs.version }}"
          delete-branch: true
          title: "feat: Add ${{ env.PACKAGE_NAME }} ${{ needs.check-pypi.outputs.version }}"
          body: |
            ### Automated Android Build ðŸ¤–
            
            **Package:** `${{ env.PACKAGE_NAME }}`
            **Version:** `${{ needs.check-pypi.outputs.version }}`
            
            **Changes:**
            - Added pre-compiled wheels for Android (Termux).
            - Architectures: `arm64`, `armv7`, `x86`, `x86_64`
            - Python Versions: 3.9 - 3.13