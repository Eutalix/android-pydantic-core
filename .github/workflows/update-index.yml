name: Update PyPI Index

on:
  workflow_dispatch:
  release:
    types: [published, edited, released, deleted]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-index:
    name: Generate PEP 503 Index
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Generate Static Site
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PKG_NAME: "pydantic-core"
        run: |
          mkdir -p site
          
          # Write the generator script
          cat <<EOF > generate_index.py
          import os
          import json
          import subprocess
          import sys

          repo = os.environ['REPO']
          pkg_name = os.environ['PKG_NAME']
          
          # PEP 503: Normalized name (lowercase, hyphens)
          # pydantic_core -> pydantic-core
          normalized_name = pkg_name.replace('_', '-').lower()

          print(f"üîç Fetching releases for {repo}...")
          
          # Request specific fields to match your JSON structure
          cmd = [
              "gh", "release", "list", 
              "--repo", repo, 
              "--limit", "100", 
              "--json", "assets" 
          ]
          
          result = subprocess.run(cmd, capture_output=True, text=True)
          
          if result.returncode != 0:
              print(f"‚ùå Error fetching releases: {result.stderr}")
              sys.exit(1)

          releases = json.loads(result.stdout)
          
          # Create directory: site/pydantic-core/
          target_dir = f"site/{normalized_name}"
          os.makedirs(target_dir, exist_ok=True)
          
          wheel_count = 0
          html_links = []

          for release in releases:
              for asset in release.get('assets', []):
                  name = asset['name']
                  
                  # CRITICAL: Use 'browser_download_url' for public access.
                  # 'url' is the API endpoint and will fail with 403/404 for pip.
                  download_url = asset.get('browser_download_url')
                  
                  if name.endswith('.whl') and download_url:
                      html_links.append(f'<a href="{download_url}">{name}</a>')
                      wheel_count += 1

          # 1. Generate Package Index (site/pydantic-core/index.html)
          html_content = f"""<!DOCTYPE html>
          <html>
          <body>
              <h1>Links for {normalized_name}</h1>
              {'<br>'.join(html_links)}
          </body>
          </html>"""
          
          with open(f"{target_dir}/index.html", "w") as f:
              f.write(html_content)
              
          # 2. Generate Root Redirect (site/index.html)
          # This helps if you visit the root URL in a browser
          root_content = f"""<!DOCTYPE html>
          <html>
          <head><meta http-equiv="refresh" content="0; url={normalized_name}/" /></head>
          <body>
              <a href="{normalized_name}/">Go to {normalized_name}</a>
          </body>
          </html>"""

          with open("site/index.html", "w") as f:
              f.write(root_content)

          print(f"‚úÖ Generated index for {normalized_name} with {wheel_count} wheels.")
          EOF
          
          # Run the script
          python3 generate_index.py

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    name: Deploy to GitHub Pages
    needs: build-index
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4